<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <script src="https://robinoconnell.us/js/theme.js"></script>
    <script src="https://robinoconnell.us/lib/parvus.min.js"></script>
    <link href="https://robinoconnell.us/lib/parvus.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://robinoconnell.us/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/fd239d80d7.js" crossorigin="anonymous"></script>
    <link href="https://unpkg.com/microtip/microtip.css" rel="stylesheet">
    <title>Git Clone | Robin O&apos;Connell</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <canvas></canvas>
    <main>
        <header>
            <h1>Robin O&apos;Connell</h1>
            <p id="tagline-container" data-anim-state="idle">
                <span id="tagline">&nbsp;<button aria-label="Regenerate tagline" title="Regenerate tagline"><i class="fa fa-redo"></i></button></span>
                <span id="old-tagline" aria-hidden>&nbsp;<button disabled><i class="fa fa-redo"></i></button></span>
            </p>
        </header>
        <nav>
            <div class="nav__mobile">
                <h1>Robin O&apos;Connell</h1>
                <button title="Open navigation" aria-label="Open navigation" class="nav__button" data-micromodal-trigger="modal-nav"><i class="fa fa-bars"></i></button>
            </div>
            <div class="nav__links">
                <div class="nav__link-group">
                    <a href="/">home</a>
                    <a href="/#projects">projects</a>
                    <a href="/#skills">skills</a>
                    <a href="/#about">about</a>
                </div>
                <div class="nav__link-group">
                    <a href="https://github.com/spindlymist/" target="_blank"><i class="fab fa-github"></i> github</a>
                    <a href="#please-enable-javascript" title="Please enable JavaScript to see email address" data-mailto="nibor@su.llennoconibor"><i class="far fa-envelope"></i> contact</a>
                    <a href="#!" class="theme-toggle" data-theme="light"><i class="fas fa-sun light-only"></i><i class="fas fa-moon dark-only"></i> theme</a>
                </div>
            </div>
        </nav>
        <section id="git-clone">
    <h2>Git Clone</h2><div class="project-links"><a href="https:&#x2F;&#x2F;github.com&#x2F;spindlymist&#x2F;wyag_in_rust" target="_blank">
        <i class="fas fa-code"></i>
        <span class="project-links__label">View source</span>
    </a></div><p>wyag (<strong>W</strong>rite <strong>Y</strong>ourself <strong>a</strong> <strong>G</strong>it) is a simplified clone of Git written in Rust. I wrote it to deepen my understanding of Git and to solidify and expand my knowledge of Rust after working through <a href="https://doc.rust-lang.org/book/title-page.html">the Rust book</a>. I started out following <a href="https://wyag.thb.lt/">a Python-based guide written by Thibault Polge</a> (hence the name) but diverged considerably along the wayâ€”not least because Polge's guide is unfinished.</p>
<p>See below for a detailed account of wyag's features, limitations, and test methodology as well as my reflection on how the codebase could be improved.</p>

<h3>Tools &amp; Technologies</h3>
<div class="cat-list"><div class="cat-list__category"><h4>Languages</h4><ul><li>Rust</li><li>Python</li></ul>
    </div><div class="cat-list__category"><h4>Crates</h4><ul><li>CLI: clap</li><li>Error handling: anyhow, thiserror</li><li>Testing: assert_fs, dir-diff, predicates, sevenz-rust</li><li>Utility: base16ct, byteorder, flate2, itertools, ordered-multimap, path-absolutize, regex, rust-ini, sha1</li></ul>
    </div></div>
<h3 id="features">Features</h3>
<p>The core functionality of the following Git commands is implemented in wyag:</p>
<ul>
<li><code>add</code></li>
<li><code>branch</code></li>
<li><code>cat-file</code></li>
<li><code>commit</code></li>
<li><code>hash-object</code></li>
<li><code>init</code></li>
<li><code>log</code></li>
<li><code>ls-files</code></li>
<li><code>ls-tree</code></li>
<li><code>restore</code></li>
<li><code>rev-parse</code></li>
<li><code>rm</code></li>
<li><code>show-ref</code></li>
<li><code>status</code></li>
<li><code>switch</code></li>
<li><code>tag</code></li>
</ul>
<p>This subset of commands is sufficient for a single-branch workflow. <code>branch</code> and <code>switch</code> allow the creation and use of additional branches, but the presently unimplemented <code>merge</code> command is needed to take full advantage of them.</p>
<h3 id="limitations">Limitations</h3>
<p>All git commands not listed in the previous section are unavailable. Notably, <code>merge</code>, <code>rebase</code>, <code>revert</code>, and <code>reset</code> have not been implemented. Furthermore, most commands only support a subset of the options available in git.</p>
<p>While the <code>checkout</code> command is not implemented, <code>switch</code> and <code>restore</code> cover the majority of its use cases. In fact, these commands were created with the intent of splitting up the overloaded <code>checkout</code> command: see <a href="https://github.com/git/git/commit/f496b064fc1135e0dded7f93d85d72eb0b302c22">commit f496b06</a> in the Git repo.</p>
<p>Additionally:</p>
<ul>
<li>This program has only been tested on Windows. Notably, treatment of file stats and permissions has been simplified. Also, its behavior with symlinks is undefined and likely incorrect.</li>
<li><code>.gitignore</code> is not supported.</li>
<li>Packfiles are not supported.</li>
<li>Remotes are not supported.</li>
<li>Commands that take a pathspec in git only accept a path.</li>
<li>Commands that take a tree-ish in git accept either only a commit identifier or only a tree hash.</li>
<li>The <code>switch</code> command will not switch branches if there are any uncommitted changes in the index or working directory. (Git allows this as long as the operation is nondestructive.)</li>
<li>Index extensions are not supported. Any extension data present is erased when the index is updated.</li>
<li>Most config options are not supported. Global config is not supported at all.</li>
<li>The <code>log</code> command outputs a representation of the commit graph in the graph description language <a href="https://en.wikipedia.org/wiki/DOT_(graph_description_language)">DOT</a>. It can be visualized with <a href="https://graphviz.org/">Graphviz</a> (<a href="https://dreampuf.github.io/GraphvizOnline/">try it here</a>).</li>
</ul>
<h3 id="tests">Tests</h3>
<p>Unit tests are present in many modules where appropriate, but because Git primarily operates on the file system, the testing strategy relies heavily on integration tests.</p>
<h4 id="snapshots">Snapshots</h4>
<p>In addition to the usual obstacles involved when testing code that interacts with the file system, there is the added dimension that file timestamps (e.g. modification time) are meaningful (in particular, they are stored in the index file). To overcome this, the testing apparatus is based around "snapshots" stored in <code>.7z</code> archives, which are able to save and restore the timestamps associated with their contents. These archives are stored in the <a href="/snapshots"><code>/snapshots</code></a> directory.</p>
<p>Most integration tests follow this procedure:</p>
<ol>
<li>Extract a "before" snapshot to a temporary directory.</li>
<li>Execute a command on the temp directory.</li>
<li>Extract an "after" snapshot and compare it to the temp directory.</li>
</ol>
<h4 id="recipes">Recipes</h4>
<p>To generate and vet the correctness of these snapshots, a Python script <a href="https://robinoconnell.us/projects/wyag/scripts/snapshots.py"><code>/scripts/snapshots.py</code></a> has been provided. Each snapshot is based on a "recipe" located in the <a href="https://robinoconnell.us/projects/wyag/scripts/recipes"><code>/scripts/recipes</code></a> directory. A recipe is a Python script that supplies the steps to generate the "before" snapshot (via the <code>setup</code> function), the wyag command(s) being tested (<code>run_wyag</code> function), and the equivalent Git commands (<code>run_git</code> function) which serve as the ground truth.</p>
<p>When the recipe is executed with the <code>snapshots.py generate</code> command, two identical copies of the "before" snapshot are created. The wyag commands are executed on one copy and the git commands are executed on the other. Then, a diff of the two directories and the contents of their index files is produced. The user is asked to confirm that any differences between the two are acceptable. (Differences often arise from unimplemented features rather than errors.) If accepted, two archives are created in the <a href="/snapshots"><code>/snapshots</code></a> directory: <code>before_&lt;recipe name&gt;.7z</code> and <code>after_&lt;recipe name&gt;.7z</code>. By convention, a recipe should use the exact name of the test that it supports.</p>
<p>To use the script, <code>git</code> and <code>7z</code> must be present on your <code>$PATH</code>. To learn more, run this command from the project's root directory:</p>
<pre data-lang="shell" class="language-shell "><code class="language-shell" data-lang="shell">python scripts&#x2F;snapshots.py --help
</code></pre>
<h4 id="coverage">Coverage</h4>
<p>Integration tests have been written for almost all commands that modify the file system, including:</p>
<ul>
<li><code>add</code></li>
<li><code>branch</code></li>
<li><code>commit</code></li>
<li><code>hash-object</code></li>
<li><code>init</code></li>
<li><code>rm</code></li>
<li><code>tag</code></li>
</ul>
<p>Most other commands simply read from the file system and output information to the console. Notably, however, the <code>switch</code> and <code>restore</code> commands (which do modify the file system) lack appropriate coverage due to challenges with timestamps that will require a rework of the testing apparatus.</p>
<h3 id="future-work">Future Work</h3>
<p>Due to the educational nature of this project, I have limited plans to continue its development. However, I plan to implement the most critical missing feature, the <code>merge</code> command, which is the final piece required to support a multi-branch workflow.</p>
<p>If I were to continue development beyond that, I would:</p>
<ul>
<li>Address the most pressing limitations described above.</li>
<li>Take better advantage of Rust's type system by making more use of traits and reducing reliance on primitive types.</li>
<li>Develop a unified system for traversing, comparing, modifying, and converting between the three file trees (<code>WorkDir</code>, <code>Index</code>, and <code>Tree</code>). Their differences pose a challenge to creating a coherent, performant abstraction, but I believe it is possible.</li>
<li>Improve algorithmic clarity. Many algorithms that use the file system could be made clearer (and perhaps even more performant) by separating file system interactions from processing at the cost of consuming more memory.</li>
<li>Refactor the <code>object</code> module. It is rare to abstract over multiple types of objects, so the <code>GitObject</code> type is not extremely useful. I would rather use a trait and replace the methods of <code>GitObject</code> with a set of functions that are generic over that trait.</li>
<li>Limit the direct dependence of modules on the file system. This would allow for more extensive unit testing.</li>
<li>Improve the testing apparatus and test coverage. In particular, I would fold the functionality of the Python scripts into the <a href="/tests/common"><code>common</code> test module</a> module. Then, I would incorporate the recipes into the tests they support, reducing the maintenance burden. Finally, I would automate comparisons to the ground truth as much as possible, supported by unit tests to ensure the integrity of the system.</li>
<li>Improve error reporting. In particular, adding context (<a href="https://docs.rs/anyhow/latest/anyhow/trait.Context.html"><code>anyhow::Context</code></a>) or bespoke errors in the many places where I/O errors can occur would improve the legibility of error messages.</li>
</ul>
</section>
    </main>
    <div id="modal-nav" aria-hidden="true">
        <div tabindex="-1">
            <div role="dialog" aria-modal="true" aria-labelledby="modal-nav-title">
                <div class="modal-nav-header">
                    <h2 id="modal-nav-title">Navigation</h2>
                    <button class="nav__button" title="Close navigation" aria-label="Close navigation" data-micromodal-close><i class="fa fa-times"></i></button>
                </div>
                <div class="modal-nav-content">
                    <div class="nav__delayed"><a href="/">home</a></div>
                    <div class="nav__delayed"><a href="/#projects">projects</a></div>
                    <div class="nav__delayed"><a href="/#skills">skills</a></div>
                    <div class="nav__delayed"><a href="/#about">about</a></div>
                    <div class="nav__delayed"><a href="https://github.com/spindlymist/" target="_blank"><i class="fab fa-github"></i> github</a></div>
                    <div class="nav__delayed"><a href="#please-enable-javascript" title="Please enable JavaScript to see email address" data-mailto="nibor@su.llennoconibor"><i class="far fa-envelope"></i> contact</a></div>
                    <div class="nav__delayed"><a href="#!" class="theme-toggle" data-theme="light"><i class="fas fa-sun light-only"></i><i class="fas fa-moon dark-only"></i> theme</a></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/micromodal/dist/micromodal.min.js"></script>
    <script src="https://robinoconnell.us/js/ui.js" type="module"></script>
    <script src="https://robinoconnell.us/js/background.js"></script>
</body>
</html>
